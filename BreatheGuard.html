<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>BreatheGuard - Air Quality Monitoring by AeroInnovians</title>
    <meta content="Smart air quality monitoring and health insights for every city with BreatheGuard." name="description">
    <meta content="air quality, aqi, pollution, health, AeroInnovians, BreatheGuard" name="keywords">

    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

    <!-- Main CSS File -->
    <link href="assets/css/main.css" rel="stylesheet">

</head>

<body class="index-page">

    <header id="header" class="header d-flex align-items-center fixed-top">
        <div class="container-fluid container-xl position-relative d-flex align-items-center">

            <a href="index.html" class="logo d-flex align-items-center me-auto">
                <img src="assets/img/favicon.png" alt="">
                <h1 class="sitename">AeroInnovians</h1>
            </a>

            <nav id="navmenu" class="navmenu">
                <ul>
                    <li><a href="index.html#hero">Home</a></li>
                    <li><a href="index.html#about">About</a></li>
                    <li class="dropdown"><a href="index.html#portfolio"><span>Our Products</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
                        <ul>
                            <li><a href="breatheguard.html" class="active">BreatheGuard</a></li>
                            <li><a href="#">AeroGen AIR</a></li>
                        </ul>
                    </li>
                    <li><a href="index.html#team">Team</a></li>
                    <li class="dropdown"><a href="#"><span>Gallery</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
                        <ul>
                            <li><a href="#">2014</a></li>
                            <li><a href="#">2015</a></li>
                            <li><a href="#">2016</a></li>
                            <li><a href="#">2017</a></li>
                            <li><a href="#">2019</a></li>
                            <li><a href="#">2020</a></li>
                            <li><a href="#">2021</a></li>
                            <li><a href="#">2024</a></li>
                        </ul>
                    </li>
                    <li><a href="index.html#contact">Contact</a></li>
                </ul>
                <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
            </nav>

        </div>
    </header>

    <main class="main">

        <!-- Hero Section -->
        <section id="hero" class="hero section">
            <div class="container">
                <div class="row gy-4">
                    <div class="col-lg-6 order-2 order-lg-1 d-flex flex-column justify-content-center">
                        <h1 data-aos="fade-up">Breathe Better with BreatheGuard</h1>
                        <p data-aos="fade-up" data-aos-delay="100">Smart air quality monitoring and health insights for every city.</p>
                        <div class="d-flex flex-column flex-md-row" data-aos="fade-up" data-aos-delay="200">
                            <a href="#about" class="btn-get-started">Get Started</a>
                        </div>
                    </div>
                    <div class="col-lg-6 order-1 order-lg-2 hero-img" data-aos="zoom-out">
                        <img src="https://placehold.co/600x400/a2d9ce/ffffff?text=BreatheGuard\nHero+Image&font=raleway" class="img-fluid animated" alt="BreatheGuard Hero Image">
                    </div>
                </div>
            </div>
        </section><!-- /Hero Section -->

        <!-- About Section -->
        <section id="about" class="about section">
            <div class="container" data-aos="fade-up">
                <div class="row gy-4">
                    <div class="col-lg-6">
                        <img src="assets/img/about-2.svg" class="img-fluid" alt="About BreatheGuard">
                    </div>
                    <div class="col-lg-6" data-aos="fade-up" data-aos-delay="200">
                        <div class="content ps-0 ps-lg-5">
                            <h3>What is BreatheGuard?</h3>
                            <p>
                                BreatheGuard is an innovative web-based application by AeroInnovians that empowers users to check air pollution levels in any city using real-time AQI data. Based on air quality, it offers science-backed health advice tailored to the pollution severity.
                            </p>
                            <ul>
                                <li><i class="bi bi-broadcast"></i> <strong>Real-time air quality data from OpenAQ.</strong></li>
                                <li><i class="bi bi-lightbulb"></i> <strong>Actionable health recommendations.</strong></li>
                                <li><i class="bi bi-globe-americas"></i> <strong>Designed for global cities.</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section><!-- /About Section -->

        <!-- Features Section -->
        <section id="features" class="features section">
            <div class="container">
                <div class="section-title" data-aos="fade-up">
                    <h2>Why Choose BreatheGuard?</h2>
                    <p>Harnessing the power of real-time data to bring you actionable health insights.</p>
                </div>
                <div class="row gy-4">
                    <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="100">
                        <div class="feature-item">
                            <i class="bi bi-cloud-haze2" style="color: #ffbb2c;"></i>
                            <h3>Live AQI Monitoring</h3>
                            <p>Tracks real-time air quality for your city, focusing on the most harmful pollutants like PM2.5.</p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="200">
                        <div class="feature-item">
                            <i class="bi bi-clipboard2-pulse" style="color: #5578ff;"></i>
                            <h3>Health Tips Engine</h3>
                            <p>Provides WHO-aligned recommendations based on AQI levels to help you minimize health risks.</p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="300">
                        <div class="feature-item">
                            <i class="bi bi-phone" style="color: #e80368;"></i>
                            <h3>Mobile-Optimized UI</h3>
                            <p>A lightweight and fast interface ensures you can get information quickly, even in low-connectivity areas.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section><!-- /Features Section -->

        <!-- Live Demo Section -->
        <section id="demo" class="demo section">
            <div class="container">
                <div class="section-title" data-aos="fade-up">
                    <h2>Live Air Quality Check</h2>
                    <p>Enter a city name to get the latest PM2.5 air quality data and personalized health suggestions.</p>
                </div>
                <div class="row justify-content-center">
                    <div class="col-lg-8" data-aos="fade-up" data-aos-delay="100">
                        <div class="card shadow-sm">
                            <div class="card-body p-4">
                                <form id="aqi-form">
                                    <div class="input-group mb-3">
                                        <input type="text" id="city-input" class="form-control form-control-lg" placeholder="Enter City Name (e.g., Delhi)" required>
                                        <button class="btn btn-primary" type="submit" id="search-button">
                                            <i class="bi bi-search"></i> Search
                                        </button>
                                    </div>
                                </form>
                                <div id="result-container" class="mt-4" style="display: none;">
                                    <div id="loader" class="text-center" style="display: none;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Fetching data...</p>
                                    </div>
                                    <div id="location-list-container" class="mt-3">
                                        <!-- Locations will be loaded here -->
                                    </div>
                                    <div id="result-display"></div>
                                    <div id="ai-tips-loader" class="text-center mt-3" style="display: none;">
                                        <div class="spinner-border text-success" role="status">
                                            <span class="visually-hidden">Generating tips...</span>
                                        </div>
                                        <p class="mt-2">Generating personalized tips...</p>
                                    </div>
                                    <div id="ai-tips-display" class="mt-4"></div>
                                </div>
                                <div class="text-center mt-3">
                                    <small class="text-muted">AQI data powered by <a href="https://openaq.org" target="_blank" rel="noopener noreferrer">OpenAQ</a>. Personalized tips by <a href="https://developers.generativeai.google/models/gemini" target="_blank" rel="noopener noreferrer">Gemini API</a>.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- /Live Demo Section -->

        <!-- Contact Section -->
        <section id="contact" class="contact section">
            <div class="container" data-aos="fade-up">
                <div class="section-title">
                    <h2>Get in Touch</h2>
                    <p>Have questions or want to collaborate? Reach out to AeroInnovians.</p>
                </div>
                <div class="row gy-4 justify-content-center">
                    <div class="col-lg-8">
                        <div class="info-wrap">
                            <div class="info-item d-flex" data-aos="fade-up" data-aos-delay="200">
                                <i class="bi bi-geo-alt flex-shrink-0"></i>
                                <div>
                                    <h3>Address</h3>
                                    <p>A123 Innovation Hub, Tech City, IN</p>
                                </div>
                            </div>
                            <div class="info-item d-flex" data-aos="fade-up" data-aos-delay="400">
                                <i class="bi bi-envelope flex-shrink-0"></i>
                                <div>
                                    <h3>Email Us</h3>
                                    <p>contact@aeroinnovians.example.com</p>
                                </div>
                            </div>
                            <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3506.223393427793!2d77.02663851507961!3d28.47955598246996!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x390d19d582e3885f%3A0x945b1caf75735b54!2sCyber%20Hub!5e0!3m2!1sen!2sin!4v1622552395122!5m2!1sen%202sin" frameborder="0" style="border:0; width: 100%; height: 270px;" allowfullscreen="" loading="lazy"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </section><!-- /Contact Section -->

    </main>

    <footer id="footer" class="footer">
        <div class="container footer-top">
            <div class="row gy-4">
                <div class="col-lg-4 col-md-6 footer-about">
                    <a href="index.html" class="logo d-flex align-items-center">
                        <span class="sitename">AeroInnovians</span>
                    </a>
                    <div class="footer-contact pt-3">
                        <p>A123 Innovation Hub</p>
                        <p>Tech City, IN</p>
                        <p class="mt-3"><strong>Email:</strong> <span>contact@aeroinnovians.example.com</span></p>
                    </div>
                    <div class="social-links d-flex mt-4">
                        <a href=""><i class="bi bi-twitter-x"></i></a>
                        <a href=""><i class="bi bi-facebook"></i></a>
                        <a href=""><i class="bi bi-instagram"></i></a>
                        <a href=""><i class="bi bi-linkedin"></i></a>
                    </div>
                </div>

                <div class="col-lg-2 col-md-3 footer-links">
                    <h4>Useful Links</h4>
                    <ul>
                        <li><a href="index.html#hero">Home</a></li>
                        <li><a href="index.html#about">About us</a></li>
                        <li><a href="#">Terms of service</a></li>
                        <li><a href="#">Privacy policy</a></li>
                    </ul>
                </div>

                <div class="col-lg-2 col-md-3 footer-links">
                    <h4>Our Products</h4>
                    <ul>
                        <li><a href="breatheguard.html">BreatheGuard</a></li>
                        <li><a href="#">AeroGen AIR</a></li>
                        <li><a href="#">SkyNet</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scroll Top -->
    <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

    <!-- Preloader -->
    <div id="preloader"></div>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

    <!-- Main JS File -->
    <script src="assets/js/main.js"></script>

    <!-- Page-specific JS for AQI Fetch and AI Tips -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const aqiForm = document.getElementById('aqi-form');
            const cityInput = document.getElementById('city-input');
            const resultContainer = document.getElementById('result-container');
            const resultDisplay = document.getElementById('result-display');
            const loader = document.getElementById('loader');
            const locationListContainer = document.getElementById('location-list-container'); // New container for location list
            const aiTipsLoader = document.getElementById('ai-tips-loader');
            const aiTipsDisplay = document.getElementById('ai-tips-display');

            // Function to determine health suggestion based on AQI value
            const getHealthSuggestion = (aqi) => {
                if (aqi === null || typeof aqi === 'undefined') {
                    return { suggestion: "Could not retrieve valid AQI data.", colorClass: "alert-secondary", category: "Unknown" };
                }
                if (aqi <= 50) return { suggestion: "<strong>Good:</strong> Air quality is satisfactory. Enjoy your usual outdoor activities.", colorClass: "alert-success", category: "Good" };
                if (aqi <= 100) return { suggestion: "<strong>Moderate:</strong> Unusually sensitive individuals should consider reducing prolonged or heavy exertion outdoors.", colorClass: "alert-warning", category: "Moderate" };
                if (aqi <= 150) return { suggestion: "<strong>Unhealthy for Sensitive Groups:</strong> People with heart or lung disease, older adults, and children should reduce prolonged or heavy exertion.", colorClass: "alert-orange", category: "Unhealthy for Sensitive Groups" };
                if (aqi <= 200) return { suggestion: "<strong>Unhealthy:</strong> Everyone should reduce prolonged or heavy exertion. It's advisable to wear a mask outdoors.", colorClass: "alert-danger", category: "Unhealthy" };
                if (aqi <= 300) return { suggestion: "<strong>Very Unhealthy:</strong> Avoid all physical activity outdoors. People with respiratory or heart problems should remain indoors.", colorClass: "alert-purple", category: "Very Unhealthy" };
                return { suggestion: "<strong>Hazardous:</strong> Everyone should avoid all outdoor exertion. Remain indoors and keep activity levels low.", colorClass: "alert-maroon", category: "Hazardous" };
            };

            // Function to fetch and display AQI for a specific location
            const fetchAndDisplayAQIForLocation = async (locationName, cityName) => {
                loader.style.display = 'block';
                resultDisplay.innerHTML = ''; // Clear previous AQI results
                aiTipsDisplay.innerHTML = ''; // Clear previous AI tips
                locationListContainer.innerHTML = ''; // Clear location list

                const apiUrl = `https://api.openaq.org/v2/latest?limit=1&location=${encodeURIComponent(locationName)}&parameter=pm25`;

                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`OpenAQ API HTTP error! Status: ${response.status}, Raw Response: ${errorText}`);
                        let errorMessage = `Failed to fetch AQI data for "${locationName}". `;
                        if (response.status === 400 || response.status === 404) {
                            errorMessage += "No data found for this location. It might be temporarily offline or not reporting PM2.5.";
                        } else if (response.status === 429) {
                            errorMessage += "You've made too many requests. Please wait a moment and try again.";
                        } else if (response.status >= 500) {
                            errorMessage += "The air quality data server is experiencing issues. Please try again later.";
                        } else {
                            errorMessage += `An unexpected server response occurred (Status: ${response.status}).`;
                        }
                        resultDisplay.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
                        return;
                    }

                    const data = await response.json();

                    if (data.results && data.results.length > 0) {
                        const measurement = data.results[0].measurements.find(m => m.parameter === 'pm25');
                        if (measurement) {
                            const aqiValue = measurement.value;
                            const location = data.results[0].location;
                            const parameter = measurement.parameter.toUpperCase();
                            const suggestionDetails = getHealthSuggestion(aqiValue);

                            resultDisplay.innerHTML = `
                                <div class="alert ${suggestionDetails.colorClass} text-white">
                                    <h4 class="alert-heading">Air Quality in ${location} (${cityName.charAt(0).toUpperCase() + cityName.slice(1)})</h4>
                                    <p><strong>${parameter} Level:</strong> ${aqiValue.toFixed(2)} µg/m³</p>
                                    <hr>
                                    <p class="mb-0">${suggestionDetails.suggestion}</p>
                                </div>`;
                            await generateAIHealthTips(cityName, aqiValue, suggestionDetails.category);
                        } else {
                            resultDisplay.innerHTML = `<div class="alert alert-info">No PM2.5 data found for station "${locationName}". Please try another station.</div>`;
                        }
                    } else {
                        resultDisplay.innerHTML = `<div class="alert alert-danger">No data found for station "${locationName}". It might be temporarily offline or not reporting PM2.5.</div>`;
                    }

                } catch (error) {
                    console.error("OpenAQ API Fetch Error:", error);
                    let displayMessage = `An unexpected error occurred while fetching AQI data.`;
                    if (error instanceof TypeError && String(error).includes('Failed to fetch')) {
                        // This specific message suggests a CORS issue or network blockade
                        displayMessage = `Network error: Could not connect to the air quality service. This is often due to browser security (CORS policy) when hosting on platforms like GitHub Pages. Please try running the app locally or check your browser's console for more details.`;
                    } else if (error instanceof SyntaxError && String(error).includes('JSON')) {
                        displayMessage = `Data format error: The air quality service sent an unreadable response.`;
                    } else {
                        displayMessage = `An unexpected JavaScript error occurred: ${error.message}.`;
                    }
                    resultDisplay.innerHTML = `<div class="alert alert-danger">${displayMessage}</div>`;
                } finally {
                    loader.style.display = 'none';
                }
            };


            // Function to generate personalized health tips using Gemini API
            const generateAIHealthTips = async (city, aqiValue, aqiCategory) => {
                aiTipsDisplay.innerHTML = ''; // Clear previous AI tips
                aiTipsLoader.style.display = 'block'; // Show AI tips loader

                const prompt = `Given that the air quality in ${city} for PM2.5 is ${aqiValue.toFixed(2)} µg/m³, which is categorized as "${aqiCategory}", provide 3-4 personalized and actionable health tips for a general resident. Focus on practical advice for daily life (e.g., outdoor activities, ventilation, diet). Keep the tips concise and direct.`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this dynamically

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Check if the response is okay before parsing JSON
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Gemini API HTTP error! Status: ${response.status}, Raw Response: ${errorText}`);
                        throw new Error(`Gemini API returned status ${response.status}: ${errorText.substring(0, 100)}...`);
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const aiText = result.candidates[0].content.parts[0].text;
                        aiTipsDisplay.innerHTML = `
                            <div class="card mt-3">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Personalized Health Tips (AI-Powered)</h5>
                                </div>
                                <div class="card-body">
                                    <p>${aiText.replace(/\n/g, '<br>')}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        aiTipsDisplay.innerHTML = `<div class="alert alert-info mt-3">Could not generate personalized tips at this moment (no candidates found).</div>`;
                        console.warn("Gemini API response contained no valid candidates:", result);
                    }
                } catch (error) {
                    console.error("Gemini API Fetch Error:", error);
                    let displayMessage = `An unexpected error occurred while generating personalized tips.`;
                    if (error instanceof TypeError && String(error).includes('Failed to fetch')) {
                        displayMessage = `Network error: Could not connect to the AI service. Please check your internet connection or try again later.`;
                    } else if (error instanceof SyntaxError && String(error).includes('JSON')) {
                        displayMessage = `AI service data format error: The AI service sent an unreadable response.`;
                    } else if (error.message.includes('status 429')) {
                        displayMessage = `AI service rate limit exceeded. Please wait a moment and try again.`;
                    } else {
                         displayMessage = `An unexpected AI generation error occurred: ${error.message}.`;
                    }
                    aiTipsDisplay.innerHTML = `<div class="alert alert-danger mt-3">${displayMessage}</div>`;
                } finally {
                    aiTipsLoader.style.display = 'none'; // Hide AI tips loader
                }
            };


            // Function to handle the initial city search and display locations
            const handleCitySearch = async (city, originalCityName) => {
                loader.style.display = 'block';
                resultDisplay.innerHTML = ''; // Clear previous AQI results
                aiTipsDisplay.innerHTML = ''; // Clear previous AI tips
                locationListContainer.innerHTML = ''; // Clear previous location list
                aiTipsLoader.style.display = 'none'; // Ensure AI loader is hidden

                // OpenAQ API URL - fetching latest data for locations within the city, specifically for pm25
                const apiUrl = `https://api.openaq.org/v2/latest?limit=100&city=${encodeURIComponent(city)}&parameter=pm25&order_by=location`;

                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`OpenAQ API HTTP error! Status: ${response.status}, Raw Response: ${errorText}`);
                        let errorMessage = `Failed to fetch air quality locations for "${originalCityName}". `;

                        if (response.status === 400 || response.status === 404) {
                            errorMessage += `No locations found for "${originalCityName}" with PM2.5 data. Please check the city name or try another city.`;
                        } else if (response.status === 429) {
                            errorMessage += `You've made too many requests. Please wait a moment and try again.`;
                        } else if (response.status >= 500) {
                            errorMessage += "The air quality data server is experiencing issues. Please try again later.";
                        } else {
                            errorMessage += `An unexpected server response occurred (Status: ${response.status}).`;
                        }
                        resultDisplay.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
                        return;
                    }
                    
                    const data = await response.json();
                    
                    if (!data.results || data.results.length === 0) {
                        resultDisplay.innerHTML = `<div class="alert alert-danger">No PM2.5 air quality stations found for "${originalCityName}". This could be due to:
                            <ul>
                                <li>The city name might be spelled differently in the database (e.g., "New York" instead of "New York City").</li>
                                <li>No active PM2.5 sensors reporting data for this specific city.</li>
                                <li>The city might not be covered by OpenAQ or the data is not recent.</li>
                            </ul>
                            Please try a common spelling, a major nearby city, or a country capital.
                        </div>`;
                        return;
                    }

                    // Extract unique locations with PM2.5 data
                    const uniqueLocations = new Map(); // Using Map to maintain order and uniqueness
                    data.results.forEach(res => {
                        const pm25Measurement = res.measurements.find(m => m.parameter === 'pm25');
                        if (pm25Measurement && res.location) {
                            // Use location name as key for uniqueness
                            uniqueLocations.set(res.location, {
                                location: res.location,
                                city: res.city,
                                country: res.country,
                                value: pm25Measurement.value // Store value for potential display preview
                            });
                        }
                    });

                    if (uniqueLocations.size > 0) {
                        let locationsHtml = `<p>Select a station in ${originalCityName.charAt(0).toUpperCase() + originalCityName.slice(1)}:</p><ul class="list-group">`;
                        uniqueLocations.forEach((locData) => {
                            locationsHtml += `
                                <li class="list-group-item list-group-item-action" 
                                    data-location="${locData.location}" 
                                    data-city="${locData.city}"
                                    style="cursor: pointer;">
                                    <strong>${locData.location}</strong> (${locData.value.toFixed(2)} µg/m³)
                                </li>`;
                        });
                        locationsHtml += `</ul>`;
                        locationListContainer.innerHTML = locationsHtml;

                        // Attach event listeners to each location item
                        locationListContainer.querySelectorAll('.list-group-item-action').forEach(item => {
                            item.addEventListener('click', () => {
                                const selectedLocation = item.dataset.location;
                                const selectedCity = item.dataset.city;
                                fetchAndDisplayAQIForLocation(selectedLocation, selectedCity);
                            });
                        });
                        resultDisplay.innerHTML = ''; // Clear previous messages if locations are found
                    } else {
                        resultDisplay.innerHTML = `<div class="alert alert-danger">No PM2.5 air quality stations found for "${originalCityName}". Please try a common spelling, a major nearby city, or a country capital.</div>`;
                    }

                } catch (error) {
                    console.error("OpenAQ API Fetch Error (for locations):", error);
                    let displayMessage = `An unexpected error occurred while searching for stations.`;
                    if (error instanceof TypeError && String(error).includes('Failed to fetch')) {
                        // This specific message suggests a CORS issue or network blockade
                        displayMessage = `Network error: Could not connect to the air quality service. This is often due to browser security (CORS policy) when hosting on platforms like GitHub Pages. Please try running the app locally or check your browser's console for more details.`;
                    } else if (error instanceof SyntaxError && String(error).includes('JSON')) {
                        displayMessage = `Data format error: The air quality service sent an unreadable response when fetching locations.`;
                    } else {
                         displayMessage = `An unexpected JavaScript error occurred: ${error.message}.`;
                    }
                    resultDisplay.innerHTML = `<div class="alert alert-danger">${displayMessage}</div>`;
                } finally {
                    loader.style.display = 'none';
                }
            };


            // Event listener for form submission (initial city search)
            aqiForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                // Clean the city input: remove leading/trailing whitespace, non-alphanumeric characters at the end, and multiple internal spaces
                let city = cityInput.value.trim().replace(/[^a-zA-Z\s]+$/, '').replace(/\s+/g, ' ');
                
                if (!city) {
                    resultDisplay.innerHTML = `<div class="alert alert-danger">Please enter a valid city name.</div>`;
                    aiTipsDisplay.innerHTML = '';
                    loader.style.display = 'none';
                    resultContainer.style.display = 'block';
                    return;
                }

                const originalCityName = cityInput.value.trim();
                resultContainer.style.display = 'block'; // Make sure the container is visible
                await handleCitySearch(city, originalCityName);
            });

            // Adding custom styles for AQI alerts
            const style = document.createElement('style');
            style.textContent = `
                .alert-orange { background-color: #fd7e14; color: white; border-color: #fd7e14; }
                .alert-purple { background-color: #6f42c1; color: white; border-color: #6f42c1; }
                .alert-maroon { background-color: #8B0000; color: white; border-color: #8B0000; }
                .list-group-item-action:hover {
                    background-color: #e9ecef; /* Lighter hover for Bootstrap list group items */
                    color: #0056b3; /* Darker text on hover */
                }
            `;
            document.head.appendChild(style);
        });
    </script>

</body>

</html>
